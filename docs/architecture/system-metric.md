# 分布式系统指标

## SLA

SLA(Service-Level Agreement), 也就是服务等级协议，指的是系统服务提供者（Provider）对于客户（customer)的一个服务承诺，这是衡量一个大型分布式系统是否“健康”的常见方法。

因为 SLA 是一个服务承诺，所以指标可以多种多样。

最常见的四个 SLA 指标：

- 可用性
- 准确性
- 系统容量
- 延迟

### 可用性 -- 99.99% Availability

对于许多系统而言，四个 9 的可用性（99.99% Availability，或每年约 50 分钟的系统中断时间）即可以被认为是 **高可用性** （High availability）

> 24 * 60 * 365 * 0.0001 = 52.56 min

### 准确性(Accuracy)

往往用 **错误率** 来衡量准确性这一项 SLA

> 错误率 = 导致系统产生内部错误的有效请求书/期间的有效请求数

> 可以采用 **性能测试** 或者是 **查看系统日志** 两种方式来评估

例子:

- Google Cloud Platform 的 SLA 中，每个月系统的错误率超过 5% 的时间要少于 0.1%，以每分钟为单位来计算

- 亚马逊 AWS 云计算平台有着稍微不一样的准确性定义：以每 5 分钟为单位，错误率不会超过 0.1%

### 系统容量（Capacity）-- QPS

系统容量通常指的是 **系统能够支持的预期负载量是多少**，一般会以每秒的请求数为单位来表示

常见的 `QPS` 就是指系统每秒可以响应多少请求数

给系统架构定义出 QPS 的方式

- 使用限流（Throttling）的方式

> 使用 Guava 的 RateLimiter 给每台服务器定义了每秒最多处理 1000 个请求

- 在系统交付前进行 **性能测试**

> 测试数据不真实，有误差

- 分析系统在实际使用时产生的日志

> 分析日志不一定可以得到系统可以承载的最大 QPS

> 要想得到系统能够承受的最大 QPS，更多的是性能测试和日志分析结合的手段

### 延迟（Lantency）

延迟指的是 **系统在收到用户的请求到响应这个请求之间的时间间隔**

在定义延迟的 SLA 时，我们常常看到系统的 SLA 会有 p95 或者是 p99 主要的延迟声明。

这里的 p 指的是 percentile，也就是百分位的意思。如果说一个系统的 p95 延迟是 1 秒的话，那就表示在 100 个请求中有 95 个请求的响应时间会小于 1 秒，而剩下的 5 个请求响应时间会大于 1 秒。

## 可扩展性（Scalability）

- 水平扩展（Horizontal Scaling）

> 在现有系统中添加新的机器节点

- 垂直扩展（Vertical Scaling）

> 提升机器性能，添加内存

## 一致性（Consistency）

- 强一致性（Strong Consistency）

> 系统中某个数据被成功更新后，后续任何对该数据的读取操作都将得到更新后的值。所以在任意时刻，同一系统所有节点中的数据是一样。

- 弱一致性（Weak Consistency）

> 系统中某个数据被更新后，后续对该数据的读取操作可能得到更新后的值，也可能是更改前的值。但经过 “不一致时间窗口” 这段时间后，后续对该数据的读取都是更新后的值。

- 最终一致性（Eventual Consistency）

> 是弱一致性的特殊形式。存储系统保证，在没有新的更新的条件下，最终所有访问都是最后更新的值。

## 持久性（Durability）

数据持久性意味着数据一旦被成功存储就可以一直继续使用，即使系统中的节点下线、宕机或数据损坏也是如此。

> 想要提高持久性，数据复制是较为通用的做法。