# Kafka

## 定义

Kafka 是一个分布式流平台：在这个平台上可以发布和订阅系统，并把它们保存起来，进行处理。

Kafka 设计是一个基于发布与订阅的 `消息系统` ，但是在存储层面又像是一个 `日志聚合系统`，由于 Kafka 的高吞吐及持久化，也让它成为 `大数据管道` 的常见选择

## 使用场景

- 传递消息

    > 消息系统，用于模块之间的解耦


- 数据分析

    > 存储用户活动日志、应用指标、日志等

- 数据管道

- 流处理

## 核心概念

### 消息与批次

批次就是同一主题，同一分区的一组消息

为了提供吞吐量，生产者会把消息分批次发给 broker

> 消息批次的发送有大小阈值和时间阈值

### 主题和分区

Kafka 的消息通过主题来分类，可以理解为是数据库的表

为了提高吞吐量，Kafka 将一个主题分为多个分区，每个分区可以分配给不同的 broker，这样就可以并行写入

> 消息发给那个分区，是生产者客户端计算的

### 分区和副本

为了数据的可靠性，每个分区数据都可以设置多个副本，每个副本分配给不同的 broker

其中一个分区副本叫做 `首领副本`，其它叫做 `跟随者副本`

首领副本处理生产者和消费者的写入和读取请求，跟踪者副本只是复制首领副本的内容
 
### 生产者

> Kafka 是一种重客户端模式，大量的逻辑是放在客户端中的

生产者创建消息，指定 topic，根据消息键或者轮询等算法计算得到分区，筹够一个消息批次，然后发给对应分区首领副本所在的 broker

> 生产者通过定时请求任一 broker 获取整个集群的元数据，比如分区首领所在的 broker 等

### 消费者与消费者群组

多个消费者组成一个消费者群组

消费者群组订阅主题，主题的分区分配给群组中的消费者读取，消费过程中，消费者提交所读分区的偏移量

> 一个分区只能同时被一个消费者读取，一个消费者可以同时读取多个分区

> 群组中的消费者的增加和移除，都会触发分区重分配，

### broker 与集群

broker: 一个独立的 Kafka 服务器

集群：由多个 broker 组成

> 其中一个 broker 称为 `集群控制器`，负责分区分配和监控 broker

### 日志与分段

Kafka 的数据存储在 `${log.dirs}/<topic>-<partition>/` 的数据目录中

Kafka 的数据存储是以日志文件的形式不断 append 的，到了时间阈值或者大小阈值，就会关闭当前写入的文件，然后创建一个新的文件写入

这样一个文件叫做 `段`，数据的过期是以段为单位的

> 每个数据目录中都会有一个映射文件，用于记录每个分段和偏移量的关系，以便于根据偏移量读取相应的分段

> Kafka 数据文件是顺序读取的，效率较高，再加上零复制技术，读取效率不一定亚于网络传输

## References

- [官方文档](https://kafka.apache.org/documentation/#quickstart)